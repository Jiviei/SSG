---
order: 7
title: "[dev] Замена isomorphic-git"
---

Как оказалось, isomorphic-git работает нестабильно. На его замену может придти wasm-git.

Поскольку wasm-git лишь компилирует libgit2 в webassembly при помощи emscripten, можно билдить не только его, но и библиотеку gramax-git (обёртка надо git2-rs, в десктопе).

Таким образом, на всех платформах будет единая логика работы гита.

Формально, в emscripten есть поддержка OPFS, но работает она неважно. Поэтому будет как и раньше использоваться IndexedDB для хранения файлов. Когда emscripten доработают поддержку OPFS, можно будет переехать на неё, поскольку там больше лимиты и производительность.

Также, поскольку реализация хранения файлов в emscripten требует синхронизации файловой системы, можно будет *просто* реализовать атомарность команд на уровне файловой системы в *браузере*. Но вопрос гонок фоновых промисов всё ещё актуален.



## **Критерии:**

-  \[ \] - На всех платформах используется libgit2

---

## Компиляция wasm-git \[x\]

Оказалось, что скомпилировать его достаточно просто. Для этого нужен `emscripten` и `cmake`. Emscripten генерирует wasm-модуль и js-файл к нему.

Экспортировать C-функции можно при помощи `EXPORTED_RUNTIME_METHODS`

Управлять реализациями файловых систем можно при помощи: `-lidbfs.js` / `-sWASMFS sFORCE_FILESYSTEM -lopfs.js` /



## Компиляция rust & libgit2 \[x\]

Emscripten в том числе поддерживает и компиляцию rust в wasm-модули, поэтому не должно ничего помешать скомпилировать gramax-git в wasm, экспортировать его команды и использовать их.

Необходимо только правильно настроить билдскрипт для libgit2, вот с этим могут возникнуть трудности.



## Хранение файлов \[x\]

У emscripten много [разных спобосов](https://emscripten.org/docs/api_reference/Filesystem-API.html#filesystem-api-filesystems) хранить файлы. По умолчанию использует `memfs` и хранит в памяти, но можно смаунтить другие.

OPFS вроде и поддерживается, но заставить её работать у меня не вышло, поэтому будем использовать IndexedDB.

Emscripten не сохраняет файлы сразу в IndexedDB, изначально он держит их в памяти и сбрасывает на диск при вызове `FS.syncfs()`. (А что если каталоги очень жирные?)

В любом случае, `BrowserFileProvider` придётся переделывать.



## Веб-воркер \[x\]

Wasm-git рекомендует использовать вебворкер для работы с гитом, чтобы не занимать основной поток. Так и будем.



## HTTP-транспорт \[x\]

Автор библиотеки wasm-git позаботился об этом вопросе и пропатчил libgit2, чтобы он мог работать, как wasm-модуль. Поэтому с этим проблем не должно быть никаких.

wasm-git: https://github.com/petersalomonsen/wasm-git



## Ограничение размера кучи \[?\]

Libgit2 собирается под таргер wasm32-unknown-emscripten. Битность у него - 32, и поэтому максимальный размер кучи 4gb. В случае, если её будет не хватать, то wasm-модуль будет выбрасывать исключение о невозможности аллокации памяти.

Эта проблема становится более насущной, потому что emscripten как основную файловую систему использует memfs - то есть хранит все файлы в памяти и лишь сбрасывает дамп в indexedfs (например)



## Breaking-change \[x\]

Реализация файловой системы emscripten несовместимо с lightning-fs, который используется сейчас. Пользователям необходимо будет переклонить каталоги. Но старые так и останутся мёртвым грузом висеть, будут недоступны.

Нужно сделать так, чтобы пользователи  могли использовать старые файлы.